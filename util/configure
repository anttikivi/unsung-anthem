#!/bin/bash

# ------------------------------------------------------------- #
#                 Obliging Ode & Unsung Anthem
# ------------------------------------------------------------- #
#
# This source file is part of the Obliging Ode and Unsung Anthem
# projects.
#
# Copyright (c) 2019 Antti Kivi
# All rights reserved
#
# ------------------------------------------------------------- #

set -x

readonly GITHUB_URL="https://github.com"
readonly COMPOSER_REPO_OWNER="anttikivi"
readonly COMPOSER_REPO_NAME="couplet-composer"
readonly COMPOSER_REPO_URL="$GITHUB_URL/$COMPOSER_REPO_OWNER/\
$COMPOSER_REPO_NAME.git"

readonly ROOT_DIR="."
readonly COMPOSER_DIRECTORY_NAME="composer"
readonly COMPOSER_DIRECTORY="$ROOT_DIR/$COMPOSER_DIRECTORY_NAME"

readonly CLEAN_BUILD_OPTION="-c"
readonly CLEAN_BUILD_SHORT_OPTION="--clean"

readonly PRESET_MODE_ARGUMENT="preset"
readonly CONFIGURE_MODE_ARGUMENT="configure"

readonly COMPOSER_EXECUTABLE_NAME="composer"

# Clean the script if clean build is enabled

clean_build=false

for arg in "$@"; do
  if [[ "$arg" == "$CLEAN_BUILD_OPTION" ]] || \
      [[ "$arg" == "$CLEAN_BUILD_SHORT_OPTION" ]]; then
    clean_build=true
  fi
done

if [[ $clean_build == true ]] && [[ -d "$COMPOSER_DIRECTORY" ]]; then
  rm -rf $COMPOSER_DIRECTORY
fi

# Run the installation and script

if [[ ! -d "$COMPOSER_DIRECTORY" ]]; then
  git clone $COMPOSER_REPO_URL $COMPOSER_DIRECTORY_NAME
  pip install --user $COMPOSER_DIRECTORY
fi

preset_mode=false

for arg in "$@"; do
  if [[ "$arg" == "$PRESET_MODE_ARGUMENT" ]]; then
    preset_mode=true
  fi
done

if [[ $preset_mode == true ]]; then
  # $COMPOSER_EXECUTABLE_NAME $PRESET_MODE_ARGUMENT "$@"
  # $CONFIGURE_MODE_ARGUMENT
  $COMPOSER_EXECUTABLE_NAME "$@" $CONFIGURE_MODE_ARGUMENT
else
  $COMPOSER_EXECUTABLE_NAME $CONFIGURE_MODE_ARGUMENT "$@"
fi
