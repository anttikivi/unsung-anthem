#!/bin/sh

# ------------------------------------------------------------- #
#                 Obliging Ode & Unsung Anthem
# ------------------------------------------------------------- #
#
# This source file is part of the Obliging Ode and Unsung Anthem
# projects.
#
# Copyright (c) 2019 Antti Kivi
# All rights reserved
#
# ------------------------------------------------------------- #

set -e

readonly COMPOSER_VERSION="0.4.5"
readonly COMPOSER_NAME="Couplet Composer"
readonly ODE_NAME="Obliging Ode"
readonly ANTHEM_NAME="Unsung Anthem"

echo "Running the Bourne Shell wrapper for $COMPOSER_NAME $COMPOSER_VERSION, \
the build script of $ODE_NAME and $ANTHEM_NAME"
echo "$COMPOSER_NAME will be run in composing mode"

readonly PRINT_DEBUG_OPTION="--print-debug"

for arg in "$@"; do
  if [ "$arg" = "$PRINT_DEBUG_OPTION" ]; then
    set -x
  fi
done

readonly ROOT_DIR="."
readonly BUILD_DIRECTORY_NAME="build"
readonly PROJECT_DIRECTORY_NAME="unsung-anthem"
readonly BUILD_DIRECTORY="$ROOT_DIR/$BUILD_DIRECTORY_NAME"
readonly IN_TREE_BUILD_DIRECTORY="$ROOT_DIR/$PROJECT_DIRECTORY_NAME\
/$BUILD_DIRECTORY_NAME"

readonly IN_TREE_BUILD_OPTION="--in-tree-build"

readonly PRESET_MODE_ARGUMENT="preset"
readonly COMPOSE_MODE_ARGUMENT="compose"

readonly COMPOSER_EXECUTABLE_NAME="couplet-composer"

# See if the directory generated by configuring mode is in place

exit_for_missing_configuration() {
  echo "The build directory wasn't found; please make sure to run the \
cofiguring script before attempting to build Obliging Ode and Unsung \
Anthem" 1>&2
  exit 1
}

in_tree_build=false

for arg in "$@"; do
  if [ "$arg" = "$IN_TREE_BUILD_OPTION" ]; then
    in_tree_build=true
  fi
done

if [ ! -d "$BUILD_DIRECTORY" ] && [ "$in_tree_build" = false ]; then
  exit_for_missing_configuration
fi

if [ ! -d "$IN_TREE_BUILD_DIRECTORY" ] && [ "$in_tree_build" = true ]; then
  exit_for_missing_configuration
fi

if ! command -v $COMPOSER_EXECUTABLE_NAME >/dev/null 2>&1; then
  exit_for_missing_configuration
fi

# Run the script

composer_executable="$(which $COMPOSER_EXECUTABLE_NAME)"
echo "The installed Couplet Composer executable is $composer_executable"

preset_mode=false

for arg in "$@"; do
  if [ "$arg" = "$PRESET_MODE_ARGUMENT" ]; then
    preset_mode=true
  fi
done

if [ "$preset_mode" = true ]; then
  # $composer_executable $PRESET_MODE_ARGUMENT "$@" $COMPOSE_MODE_ARGUMENT
  $composer_executable "$@" $COMPOSE_MODE_ARGUMENT
else
  $composer_executable $COMPOSE_MODE_ARGUMENT "$@"
fi
