#!/usr/bin/env python

# utils/build-script ---------------------------------------------*- python -*-
#
# This source file is part of the Unsung Anthem open source project and is
# adapted from the Swift.org open source project.
#
# Copyright (c) 2017 Venturesome Stone
# Licensed under GNU Affero General Public License v3.0


"""
Usage:
    build-script --preset <NAME> [--preset-file <PATH>]
    build-script --show-presets
"""

import os
import sys

from anthem_build_support.anthem_build_support import (diagnostics, namespace)

from anthem_build_support.anthem_build_support.call import \
    call_without_sleeping

from anthem_build_support.anthem_build_support.presets import \
    get_all_preset_names

from anthem_build_support.anthem_build_support.variables import \
    (HOME,
     ANTHEM_REPO_NAME,
     ANTHEM_SOURCE_ROOT)

from docopt import docopt


def main_preset(raw_options):
    # Set the names of the files from which the presets are looked up from.
    preset_file_names = [raw_options['--preset-file']] \
        if raw_options['--preset-file'] is not None \
        else [os.path.join(HOME, ".anthem-build-presets"),
              os.path.join(ANTHEM_SOURCE_ROOT,
                           ANTHEM_REPO_NAME,
                           "utils",
                           "build-presets.ini")]

    # If the option for only showing the presets is set, print the presets and
    # exit.
    if raw_options['--show-presets']:
        for name in sorted(get_all_preset_names(preset_file_names),
                           key=str.lower):
            print(name)
        return 0


def main():
    # First check if the root directory environment variable of the build is
    # set.
    if not ANTHEM_SOURCE_ROOT:
        diagnostics.fatal("could not infer source root directory (forgot to "
                          "set $ANTHEM_SOURCE_ROOT environment variable?)")

    # Then check if the root directory of the build exists and is a directory.
    if not os.path.isdir(ANTHEM_SOURCE_ROOT):
        diagnostics.fatal("source root directory \'"
                          + ANTHEM_SOURCE_ROOT
                          + "\' does not exist (forgot to set "
                            "$ANTHEM_SOURCE_ROOT environment variable?)")

    # Set the raw options of the program parsed by docopt.
    raw_opts = docopt(__doc__)

    # Determine if the script is invoked in the preset mode and dispatch
    # accordingly.
    if raw_opts['--preset'] is not None or raw_opts['--show-presets']:
        return main_preset(raw_opts)


if __name__ == '__main__':
    sys.exit(main())
