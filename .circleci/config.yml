version: 2

defaults: &defaults
  working_directory: /home/circleci/anthem/anthem
  machine:
    image: circleci/classic:latest

default_variables: &default_variables
  ANTHEM_SOURCE_ROOT: /home/circleci/anthem
  ANTHEM_REPO_NAME: anthem

default_apt_commands: &default_apt_commands
- run: sudo apt-add-repository -y "ppa:ubuntu-toolchain-r/test"
- run: sudo apt-add-repository -y "llvm-toolchain-trusty"
- run: sudo apt-add-repository -y "llvm-toolchain-trusty-4.0"
- run: sudo apt-get -y update
- run: sudo apt-get -y --no-install-suggests --no-install-recommends --force-yes install xorg-dev libglu1-mesa-dev build-essential

jobs:
  system_installation:
    <<: *defaults
    steps:
    - checkout
    - run: sudo apt-add-repository -y "ppa:ubuntu-toolchain-r/test"
    - run: sudo apt-get -y update
    - run: sudo apt-get -y --no-install-suggests --no-install-recommends --force-yes install xorg-dev libglu1-mesa-dev build-essential

  build_gcc:
    <<: *defaults
    environment:
      <<: *default_variables
      ANTHEM_BUILD_PRESET: circleci_linux_gcc5_cpp14
      COMPILER_NAME: gcc
      CXX: g++-5
      CC: gcc-5
    steps:
    - checkout
    - run: sudo apt-get -y --no-install-suggests --no-install-recommends --force-yes install g++-5
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        chmod +x $ANTHEM_REPO_NAME/utils/build-script
    - run: ${CC} --version
    - run: ${CXX} --version
    - run: pip install --user requests
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        $ANTHEM_REPO_NAME/utils/build-script --preset ${ANTHEM_BUILD_PRESET} --install
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        $ANTHEM_REPO_NAME/utils/build-script --preset ${ANTHEM_BUILD_PRESET} --build
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        $ANTHEM_REPO_NAME/utils/build-script --preset ${ANTHEM_BUILD_PRESET} --run-test

  build_sdl:
    <<: *defaults
    environment:
      <<: *default_variables
      ANTHEM_BUILD_PRESET: circleci_linux_gcc5_cpp14_sdl
      COMPILER_NAME: gcc
      CXX: g++-5
      CC: gcc-5
    steps:
    - checkout
    - run: sudo apt-get -y --no-install-suggests --no-install-recommends --force-yes install g++-5
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        chmod +x $ANTHEM_REPO_NAME/utils/build-script
    - run: ${CC} --version
    - run: ${CXX} --version
    - run: pip install --user requests
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        $ANTHEM_REPO_NAME/utils/build-script --preset ${ANTHEM_BUILD_PRESET} --install
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        $ANTHEM_REPO_NAME/utils/build-script --preset ${ANTHEM_BUILD_PRESET} --build
    - run: |
        cd $CIRCLE_WORKING_DIRECTORY/..
        $ANTHEM_REPO_NAME/utils/build-script --preset ${ANTHEM_BUILD_PRESET} --run-test

workflows:
  version: 2
  build_and_test:
    jobs:
     - system_installation
     - build_gcc:
        requires:
         - system_installation
     - build_sdl:
        requires:
         - system_installation
