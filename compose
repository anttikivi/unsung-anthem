#!/bin/sh

# Copyright (c) 2020 Antti Kivi
# Licensed under the Effective Elegy Licence

set -e

readonly COMPOSER_NAME="Couplet Composer"
readonly ODE_NAME="Obliging Ode"
readonly ANTHEM_NAME="Unsung Anthem"

echo "Running the shell script wrapper for $COMPOSER_NAME, the build script \
of $ODE_NAME and $ANTHEM_NAME"
echo "$COMPOSER_NAME will be run in composing mode"
echo "The arguments passed to the script are $@"

# Set the current directory to the source root while setting the directory constants.

current_working_directory=$PWD

if [ -z "$ODE_SOURCE_ROOT" ]; then
  cd ..
else
  cd $ODE_SOURCE_ROOT
fi

echo "The working directory is set to $PWD"

readonly BUILD_DIRECTORY_NAME="build"
readonly PROJECT_DIRECTORY_NAME="unsung-anthem"
readonly BUILD_DIRECTORY="$PWD/$BUILD_DIRECTORY_NAME"
readonly IN_TREE_BUILD_DIRECTORY="$PWD/$PROJECT_DIRECTORY_NAME\
/$BUILD_DIRECTORY_NAME"

cd $current_working_directory

echo "The working directory is set to $PWD"

readonly IN_TREE_BUILD_OPTION="--in-tree-build"

readonly PRESET_MODE_ARGUMENT="preset"
readonly COMPOSE_MODE_ARGUMENT="compose"

readonly COMPOSER_EXECUTABLE_NAME="couplet-composer"

# See if the build should be done in tree.

in_tree_build=false

for arg in "$@"; do
  if [ "$arg" = "$IN_TREE_BUILD_OPTION" ]; then
    in_tree_build=true
  fi
done

# See if the directory generated by configuring mode is in place

exit_for_missing_configuration() {
  echo "The build directory wasn't found; please make sure to run the \
cofiguring script before attempting to build Obliging Ode and Unsung \
Anthem" 1>&2
  exit 1
}

if [ ! -d "$BUILD_DIRECTORY" ] && [ "$in_tree_build" = false ]; then
  echo "The directory $BUILD_DIRECTORY is missing"
  exit_for_missing_configuration
fi

if [ ! -d "$IN_TREE_BUILD_DIRECTORY" ] && [ "$in_tree_build" = true ]; then
  echo "The directory $IN_TREE_BUILD_DIRECTORY is missing"
  exit_for_missing_configuration
fi

# Set up Couplet Composer

current_directory="${0%/*}"
current_working_directory=$PWD

$current_directory/util/set_up "$@"

# Change back to the directory of this script to prevent the set-up script from
# messing up the working directory.

cd $current_working_directory
echo "The working directory is set to $PWD"

# Switch to the correct directory.

if [ -z "$ODE_SOURCE_ROOT" ]; then
  if [ "$in_tree_build" = false ]; then
    cd ..
  fi
  ODE_SOURCE_ROOT=$PWD
else
  cd $ODE_SOURCE_ROOT
fi

echo "The working directory is set to $PWD"

# Run Couplet Composer

preset_mode=false

for arg in "$@"; do
  if [ "$arg" = "$PRESET_MODE_ARGUMENT" ]; then
    preset_mode=true
  fi
done

if [ "$preset_mode" = true ]; then
  pipenv run $COMPOSER_EXECUTABLE_NAME "$@" $COMPOSE_MODE_ARGUMENT
else
  pipenv run $COMPOSER_EXECUTABLE_NAME $COMPOSE_MODE_ARGUMENT "$@"
fi
